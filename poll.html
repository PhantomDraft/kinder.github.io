<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Лист заданий по арифметике, первый класс</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .is-invalid {
      border-color: #dc3545 !important;
    }
    .is-valid {
      border-color: #198754 !important;
    }
    .tab-content {
      margin-top: 20px;
    }
    .config-upload {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <h1 class="mb-4">Лист заданий по арифметике, первый класс</h1>
    <p><a href="https://github.com/PhantomDraft/kinder.github.io/wiki/Script-for-Generating-a-Configuration-File-for-Grade-1-Math-Worksheets">Инструкция генерация конфига</a></p>

    <!-- Блок загрузки конфигурации -->
    <div class="config-upload">
      <label for="configFileInput" class="form-label fw-bold">Загрузить конфигурацию заданий (JSON):</label>
      <input type="file" class="form-control" id="configFileInput" accept=".json">
      <div id="configStatus" class="mt-2"></div>
    </div>

    <!-- Навигационные вкладки -->
    <ul class="nav nav-tabs" id="taskTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="standard-tab" data-bs-toggle="tab" data-bs-target="#standard" type="button" role="tab" aria-controls="standard" aria-selected="true">
          Стандартные задания
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab" aria-controls="advanced" aria-selected="false" disabled>
          Специальные задания
        </button>
      </li>
    </ul>

    <!-- Содержимое вкладок -->
    <div class="tab-content" id="taskTabsContent">
      <!-- Вкладка стандартных заданий -->
      <div class="tab-pane fade show active" id="standard" role="tabpanel" aria-labelledby="standard-tab">
        <form id="standardForm" class="mt-4">
          <!-- Задания будут сгенерированы динамически -->
        </form>
        <button type="button" class="btn btn-primary mt-3" id="checkStandard">Проверить стандартные задания</button>
      </div>

      <!-- Вкладка специальных заданий -->
      <div class="tab-pane fade" id="advanced" role="tabpanel" aria-labelledby="advanced-tab">
        <form id="advancedForm" class="mt-4">
          <!-- Задания будут сгенерированы динамически -->
        </form>
        <button type="button" class="btn btn-primary mt-3" id="checkAdvanced">Проверить специальные задания</button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Arrays to hold tasks from the loaded configuration
    let standardTasks = [];
    let advancedTasks = [];

    /**
     * Function to shuffle an array using the Fisher–Yates algorithm
     * @param {Array} array
     * @returns {Array}
     */
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    /**
     * Keep only digits and insert ":" after every two digits up to HH:MM:SS
     * @param {string} value
     * @returns {string}
     */
    function formatTimeInput(value) {
      // Remove all non-digit characters, limit to 6 digits
      const digits = value.replace(/\D/g, '').slice(0, 6);
      let parts = [];
      if (digits.length >= 2) {
        parts.push(digits.substring(0, 2));
        if (digits.length >= 4) {
          parts.push(digits.substring(2, 4));
          if (digits.length > 4) {
            parts.push(digits.substring(4));
          }
        } else {
          parts.push(digits.substring(2));
        }
      } else {
        parts.push(digits);
      }
      // Join parts with colon
      return parts.join(':');
    }

    /**
     * Attach an input listener to format the field as HH:MM:SS
     * @param {HTMLInputElement} input
     */
    function attachTimeMask(input) {
      input.addEventListener('input', function() {
        // Remember cursor position
        const cursorPos = this.selectionStart;
        const oldLen = this.value.length;
        // Reformat the value
        this.value = formatTimeInput(this.value);
        // Adjust cursor to account for inserted/removed colons
        const newLen = this.value.length;
        this.selectionStart = this.selectionEnd = cursorPos + (newLen - oldLen);
      });
    }

    /**
     * Function to generate HTML tasks based on the tasks array from config
     * @param {string} formId - ID of the form container
     * @param {Array} tasksArray - Array of task objects
     */
    function generateTasks(formId, tasksArray) {
      const form = document.getElementById(formId);
      form.innerHTML = ''; // Clear the form
      tasksArray.forEach((task, index) => {
        // Create task container
        const div = document.createElement('div');
        div.className = 'mb-3';

        // Create label with task text and order number
        const label = document.createElement('label');
        label.className = 'form-label';
        label.htmlFor = task.id || `${formId}_task${index}`;
        label.textContent = `${index + 1}. ${task.text}`;

        // Create input field
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control';
        input.id = task.id || `${formId}_task${index}`;
        input.setAttribute('data-answer', task.dataAnswer);
        input.placeholder = task.placeholder || 'Enter answer here';

        // If the correct answer contains a colon, treat this as a time field
        if (task.dataAnswer.includes(':')) {
          attachTimeMask(input);
        }

        // Create feedback element for invalid input
        const feedback = document.createElement('div');
        feedback.className = 'invalid-feedback';
        feedback.textContent = 'Incorrect answer';

        // Assemble and append to the form
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(feedback);
        form.appendChild(div);
      });

      // Re-attach live validation handlers after generating new tasks
      addDynamicValidation();
    }

    /**
     * Function to add live validation on all inputs with data-answer attribute
     */
    function addDynamicValidation() {
      document.querySelectorAll('input[data-answer]').forEach(input => {
        input.addEventListener('input', function() {
          const userAnswer = this.value.trim();
          const correctAnswer = this.getAttribute('data-answer').trim();

          if (correctAnswer.includes(',')) {
            // Handle comma-separated multiple answers
            const correctArr = correctAnswer.split(',').map(item => item.trim());
            const userArr = userAnswer.split(',').map(item => item.trim());
            if (
              correctArr.length === userArr.length &&
              correctArr.every((ans, i) => ans === userArr[i])
            ) {
              this.classList.remove('is-invalid');
              this.classList.add('is-valid');
            } else {
              this.classList.remove('is-valid');
              this.classList.add('is-invalid');
            }
          } else {
            // Single answer check
            if (userAnswer === correctAnswer) {
              this.classList.remove('is-invalid');
              this.classList.add('is-valid');
            } else {
              this.classList.remove('is-valid');
              this.classList.add('is-invalid');
            }
          }
        });
      });
    }

    /**
     * Function to check all answers in a given form
     * @param {string} formId - ID of the form
     * @returns {boolean} True if all answers are correct, false otherwise
     */
    function checkAnswers(formId) {
      const form = document.getElementById(formId);
      const inputs = form.querySelectorAll('input[data-answer]');
      let allCorrect = true;

      inputs.forEach(input => {
        const userAnswer = input.value.trim();
        const correctAnswer = input.getAttribute('data-answer').trim();
        let isCorrect = false;

        if (correctAnswer.includes(',')) {
          const correctArr = correctAnswer.split(',').map(item => item.trim());
          const userArr = userAnswer.split(',').map(item => item.trim());
          isCorrect =
            correctArr.length === userArr.length &&
            correctArr.every((ans, i) => ans === userArr[i]);
        } else {
          isCorrect = userAnswer === correctAnswer;
        }

        if (isCorrect) {
          input.classList.remove('is-invalid');
          input.classList.add('is-valid');
        } else {
          input.classList.remove('is-valid');
          input.classList.add('is-invalid');
          allCorrect = false;
        }
      });

      return allCorrect;
    }

    // Event listener for loading the configuration JSON file
    document
      .getElementById('configFileInput')
      .addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const config = JSON.parse(e.target.result);
            // Expect config.standard and config.advanced arrays
            if (!config.standard || !config.advanced) {
              document.getElementById('configStatus').textContent =
                'Invalid configuration format.';
              return;
            }
            // Shuffle tasks
            standardTasks = shuffle(config.standard);
            advancedTasks = shuffle(config.advanced);
            // Generate tasks for both tabs
            generateTasks('standardForm', standardTasks);
            generateTasks('advancedForm', advancedTasks);
            document.getElementById('configStatus').textContent =
              'Configuration loaded successfully.';
          } catch (err) {
            document.getElementById('configStatus').textContent =
              'Error parsing configuration: ' + err.message;
          }
        };
        reader.readAsText(file);
      });

    // Event listener for checking standard tasks
    document
      .getElementById('checkStandard')
      .addEventListener('click', function() {
        if (checkAnswers('standardForm')) {
          alert('All standard tasks are correct!');
          // Enable advanced tasks tab
          document.getElementById('advanced-tab').removeAttribute('disabled');
          // Switch to advanced tasks tab
          const advancedTab = new bootstrap.Tab(
            document.getElementById('advanced-tab')
          );
          advancedTab.show();
        } else {
          alert('Some answers in standard tasks are incorrect. Please review.');
        }
      });

    // Event listener for checking advanced tasks
    document
      .getElementById('checkAdvanced')
      .addEventListener('click', function() {
        if (checkAnswers('advancedForm')) {
          alert('All advanced tasks are correct!');
        } else {
          alert('Some answers in advanced tasks are incorrect. Please review.');
        }
      });
  </script>
</body>
</html>